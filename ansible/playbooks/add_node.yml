---
# Playbook to add new nodes to an existing RKE2 cluster
# This playbook joins new server (control-plane) or agent (worker) nodes to an existing cluster

- hosts: new_nodes
  gather_facts: false
  become: yes
  tasks:
  - name: Create rke2 folder
    file:
      path: /etc/rancher/rke2
      state: directory

# Add new server nodes
- hosts: new_servers
  gather_facts: false
  become: yes
  tasks:
  - name: Copy config.yaml for new servers (role-specific)
    template:
      src: "/ansible/templates/{{ config_template }}"
      dest: /etc/rancher/rke2/config.yaml

  - name: Copy registries.yaml for new servers
    template:
      src: /ansible/templates/registries.yaml.j2
      dest: /etc/rancher/rke2/registries.yaml

  - name: Install RKE2 server
    shell: curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION={{ rke2_version }} sh -
    args:
      creates: /usr/local/bin/rke2

  - name: Enable rke2-server.service
    service:
      name: rke2-server.service
      enabled: yes

  - name: Start rke2-server.service
    service:
      name: rke2-server.service
      state: started

  - name: Wait for server to join cluster
    wait_for:
      timeout: 180
    delegate_to: localhost

  - name: Check server status
    shell: systemctl is-active rke2-server.service
    register: server_status
    failed_when: server_status.stdout != "active"

# Add new agent nodes
- hosts: new_agents
  gather_facts: false
  become: yes
  tasks:
  - name: Copy config.yaml for new agents (role-specific)
    template:
      src: "/ansible/templates/{{ config_template }}"
      dest: /etc/rancher/rke2/config.yaml

  - name: Copy registries.yaml for new agents
    template:
      src: /ansible/templates/registries.yaml.j2
      dest: /etc/rancher/rke2/registries.yaml

  - name: Install RKE2 agent
    shell: curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION={{ rke2_version }} INSTALL_RKE2_TYPE="agent" sh -
    args:
      creates: /usr/local/bin/rke2

  - name: Enable rke2-agent.service
    service:
      name: rke2-agent.service
      enabled: yes

  - name: Start rke2-agent.service
    service:
      name: rke2-agent.service
      state: started

  - name: Wait for agent to join cluster
    wait_for:
      timeout: 180
    delegate_to: localhost

  - name: Check agent status
    shell: systemctl is-active rke2-agent.service
    register: agent_status
    failed_when: agent_status.stdout != "active"
